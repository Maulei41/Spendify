name: CD - Deploy to Server

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-cd.yml'

jobs:
  deploy:
    # Use your self-hosted runner (adjust label if you added custom ones, e.g. 'hku-runner')
    runs-on: self-hosted

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Grant execute permissions to mvnw
        run: chmod +x mvnw

      - name: Build JAR with Maven
        run: ./mvnw -B clean package -DskipTests

      - name: Debug - List built JAR
        run: |
          echo "Current directory: $(pwd)"
          echo "Files in target/:"
          ls -la target/
          echo "JAR file:"
          find target -name "*.jar" -type f

      - name: Deploy JAR via SCP (Key-based SSH)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_KEY }}  # Your private key for the server
        run: |
          # Install SSH key temporarily
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Add host key to known_hosts to avoid StrictHostKeyChecking prompt
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

          # Copy the built JAR (there should be exactly one)
          scp target/backend-*.jar ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/${{ secrets.SSH_USER }}/spendify/app.jar

      - name: Restart app on server (Key-based SSH)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_KEY }}
        run: |
          # Reuse the same SSH key setup (in case previous step didn't persist)
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

          # Restart service and check status
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd /home/${{ secrets.SSH_USER }}/spendify
            sudo systemctl restart spendify
            sleep 3
            systemctl status spendify --no-pager
          EOF

      - name: Cleanup SSH key (security best practice)
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa