name: CD - Deploy to Server

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-cd.yml'

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Grant execute permissions to mvnw
        run: chmod +x mvnw

      - name: Build JAR with Maven
        run: ./mvnw -B clean package -DskipTests

      - name: Debug - List built JAR
        run: |
          echo "Files in target/:"
          ls -la target/
          echo "JAR file:"
          find target -name "*.jar" -type f

      - name: Deploy JAR via SCP (Key-based SSH)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

          scp target/backend-*.jar ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/${{ secrets.SSH_USER }}/spendify/app.jar

      - name: Restart app on server (with sudo password)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_KEY }}
          SUDO_PASSWORD: ${{ secrets.SUDO_PASSWORD }}  # New secret for sudo
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
            # Make sure directory exists
            mkdir -p /home/${{ secrets.SSH_USER }}/spendify

            # Use sshpass for sudo only (install if missing)
            if ! command -v sshpass &> /dev/null; then
              sudo apt-get update && sudo apt-get install -y sshpass
            fi

            # Restart service using sudo with password via sshpass
            SSHPASS="\$SUDO_PASSWORD" sshpass -e sudo systemctl restart spendify

            sleep 3
            systemctl status spendify --no-pager

            # Optional: show logs if failed
            if ! systemctl is-active --quiet spendify; then
              echo "Service failed. Recent logs:"
              journalctl -u spendify -n 20 --no-pager
              exit 1
            fi
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_rsa